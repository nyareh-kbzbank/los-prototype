import{u as he,r as a,j as t,L as ee}from"./main-D41VL2ti.js";import{u as ge}from"./loan-application-store-DANcEjpu.js";import{u as fe,g as be}from"./loan-setup-store-DJrIGAn0.js";import{i as je,e as ve}from"./scorecard-engine-QAjBW2Bv.js";import{u as Ne}from"./scorecard-store-CYp6Kdmm.js";import"./middleware-fIKtS8xN.js";import"./v4-EwEgHOG0.js";function Be(){const te=he(),R=fe(e=>e.setups),q=Ne(e=>e.scoreCards),se=ge(e=>e.addApplication),d=a.useMemo(()=>be(R),[R]),[p,M]=a.useState(d[0]?.id??""),s=a.useMemo(()=>d.find(e=>e.id===p)??d[0]??null,[d,p]);a.useEffect(()=>{d.length!==0&&(s||M(d[0].id))},[s,d]);const m=s?.product.tenureMonths??[],f=s?.channels??[],h=(s?.disbursementDestinations??[]).map(e=>e.type),v="Myanmar Credit Bureau",N="Credit assessment",c=a.useMemo(()=>s?.scorecardId?q[s.scorecardId]??null:null,[s?.scorecardId,q]),ae=a.useMemo(()=>{const e=new Set;return e.add(v),s?.bureauProvider?.trim()&&e.add(s.bureauProvider.trim()),Array.from(e)},[s?.bureauProvider]),re=a.useMemo(()=>{const e=new Set;return e.add(N),e.add("Pre-approval"),e.add("Account review"),e.add("Regulatory reporting"),s?.bureauPurpose?.trim()&&e.add(s.bureauPurpose.trim()),Array.from(e)},[s?.bureauPurpose]),y=a.useMemo(()=>c?[...c.fields.map(e=>e.field)].sort((e,n)=>e.localeCompare(n)):[],[c]),E=a.useMemo(()=>{if(!c)return{};const e={};for(const n of c.fields)e[n.field]=[...n.rules??[]];return e},[c]),S=a.useMemo(()=>y.filter(e=>e!=="age"&&e!=="monthlyIncome"),[y]),[C,ne]=a.useState(""),[A,le]=a.useState(""),[F,oe]=a.useState(""),[w,ce]=a.useState(""),[I,ue]=a.useState(""),[T,de]=a.useState(""),[$,D]=a.useState(m[0]??null),[K,O]=a.useState(f[0]?.code??""),[V,G]=a.useState(h[0]??"BANK"),[P,Y]=a.useState(v),[B,z]=a.useState(N),[b,H]=a.useState(!1),[J,Q]=a.useState(""),[j,U]=a.useState(""),[W,ie]=a.useState(""),[X,o]=a.useState(null),[Z,k]=a.useState({}),[u,_]=a.useState(null);a.useEffect(()=>{D(m[0]??null)},[p,m]),a.useEffect(()=>{O(f[0]?.code??"")},[p,f]),a.useEffect(()=>{G(h[0]??"BANK")},[p,h]),a.useEffect(()=>{k(e=>{const n={};for(const l of S)n[l]=e[l]??"";return n}),_(null)},[s?.id,S]),a.useEffect(()=>{const e=s?.bureauProvider?.trim()||v,n=s?.bureauPurpose?.trim()||N;Y(e),z(n),H(!1),Q(""),U("")},[s?.bureauProvider,s?.bureauPurpose]);const r=d.length===0,pe="DRAFT",me=()=>{if(!c){o("This loan setup is missing a linked scorecard.");return}const e={};for(const l of y){if(l==="age"){e[l]=w;continue}if(l==="monthlyIncome"){e[l]=I;continue}e[l]=Z[l]??""}const n=ve(c,e);_(n),o(null)},xe=()=>{if(r||!s)return;if(!C.trim()){o("Beneficiary name is required.");return}if(!A.trim()){o("National ID is required.");return}const e=Number(w);if(!Number.isFinite(e)||e<=0){o("Enter a valid age.");return}const n=Number(I);if(!Number.isFinite(n)||n<0){o("Enter a valid monthly income.");return}const l=Number(T);if(!Number.isFinite(l)){o("Enter a valid amount.");return}if(s.product.minAmount&&l<s.product.minAmount){o(`Amount must be at least ${s.product.minAmount.toLocaleString()}.`);return}if(s.product.maxAmount&&l>s.product.maxAmount){o(`Amount must be at most ${s.product.maxAmount.toLocaleString()}.`);return}if(s.bureauConsentRequired){if(!P.trim()){o("Select a credit bureau provider.");return}if(!B.trim()){o("Enter the purpose for the bureau check.");return}if(!b){o("Beneficiary consent is required before checking the bureau.");return}}const x=j?Date.parse(j):null;if(j&&Number.isNaN(x)){o("Enter a valid requested-at date/time.");return}o(null);const i=u?.totalScore??s.totalScore??null,g=u?.maxScore??c?.maxScore??null;se({beneficiaryName:C,nationalId:A,phone:F,age:e,monthlyIncome:n,requestedAmount:l,tenureMonths:$,channelCode:K,destinationType:V,bureauProvider:P,bureauPurpose:B,bureauConsent:b,bureauReference:J,bureauRequestedAt:x,notes:W,setupId:s.id,productCode:s.product.productCode,productName:s.product.productName,creditScore:i,creditMax:g,workflowId:s.workflowId,workflowName:s.workflowName}),te({to:"/loan/applications"})};return t.jsx("div",{className:"p-6 font-sans max-w-5xl mx-auto",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Loan applications"}),t.jsx("h1",{className:"text-2xl font-semibold",children:"Create application"})]}),r?t.jsxs("div",{className:"border rounded p-4 bg-yellow-50 text-sm text-gray-800",children:["You need at least one saved loan setup before creating applications.",t.jsx("div",{className:"mt-2",children:t.jsx(ee,{to:"/loan/setup",className:"text-blue-600 hover:underline",children:"Go to Loan Setup"})})]}):t.jsxs("div",{className:"space-y-4 border rounded p-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Loan setup (product)"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:p,onChange:e=>M(e.target.value),children:d.map(e=>t.jsxs("option",{value:e.id,children:[e.product.productName," (",e.product.productCode,")"]},e.id))}),t.jsxs("span",{className:"text-xs text-gray-600",children:["Tenure options: ",m.join(", ")||"—"," months · Range: ",s?.product.minAmount.toLocaleString()," -"," ",s?.product.maxAmount.toLocaleString()]})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Status"}),t.jsx("input",{readOnly:!0,value:pe,className:"border px-2 py-2 rounded bg-gray-50"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Beneficiary name"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:C,onChange:e=>ne(e.target.value),disabled:r})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"National ID"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:A,onChange:e=>le(e.target.value),disabled:r})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Phone"}),t.jsx("input",{type:"tel",className:"border px-2 py-2 rounded",value:F,onChange:e=>oe(e.target.value),disabled:r})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Age"}),t.jsx("input",{type:"number",min:0,className:"border px-2 py-2 rounded",value:w,onChange:e=>ce(e.target.value),disabled:r})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Monthly income"}),t.jsx("input",{type:"number",min:0,className:"border px-2 py-2 rounded",value:I,onChange:e=>ue(e.target.value),disabled:r})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Requested amount"}),t.jsx("input",{type:"number",min:s?.product.minAmount??0,max:s?.product.maxAmount??void 0,className:"border px-2 py-2 rounded",value:T,onChange:e=>de(e.target.value),disabled:r}),t.jsx("span",{className:"text-xs text-gray-600",children:s?`Allowed: ${s.product.minAmount.toLocaleString()} - ${s.product.maxAmount.toLocaleString()}`:"Save a loan setup first."})]})]}),t.jsxs("div",{className:"space-y-3 border rounded p-4",children:[t.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Credit score"}),t.jsx("div",{className:"text-base font-semibold",children:c?`${c.name} (Max ${c.maxScore})`:"No scorecard attached"})]}),u?t.jsxs("div",{className:"text-sm text-gray-700",children:["Score ",u.totalScore," / ",u.maxScore," —",u.riskGrade]}):null]}),c?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:S.map(e=>{const n=je(E[e]??[]),l=Z[e]??"",x=`score-${e}`;return t.jsxs("label",{className:"flex flex-col gap-1 text-sm",htmlFor:x,children:[t.jsx("span",{children:e}),n==="boolean"?t.jsxs("select",{id:x,value:l,onChange:i=>{const g=i.target.value;k(L=>({...L,[e]:g}))},className:"border px-2 py-2 rounded",disabled:r,children:[t.jsx("option",{value:"",children:"(not set)"}),t.jsx("option",{value:"true",children:"true"}),t.jsx("option",{value:"false",children:"false"})]}):t.jsx("input",{id:x,type:n==="number"?"number":"text",value:l,onChange:i=>{const g=i.target.value;k(L=>({...L,[e]:g}))},className:"border px-2 py-2 rounded",placeholder:(E[e]??[]).some(i=>i.operator==="between")?"For between: e.g. 25,45":"",disabled:r})]},e)})}),t.jsxs("div",{className:"flex gap-2 items-center",children:[t.jsx("button",{type:"button",onClick:me,className:"px-4 py-2 rounded bg-blue-600 text-white shadow hover:bg-blue-700",disabled:r,children:"Calculate credit score"}),u?t.jsxs("span",{className:"text-sm text-gray-700",children:["Result: ",u.totalScore," /"," ",u.maxScore," — ",u.riskGrade]}):null]})]}):t.jsx("p",{className:"text-sm text-gray-700",children:"Link a scorecard in Loan Setup to calculate credit scores per beneficiary."})]}),s?.bureauCheckRequired?t.jsxs("div",{className:"space-y-3 border rounded p-4",children:[t.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Credit bureau check"}),t.jsx("div",{className:"text-base font-semibold",children:"Capture consent and request details"})]}),b?t.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100",children:"Consent ready"}):t.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-yellow-50 text-yellow-800 border border-yellow-200",children:"Consent required"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau provider"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:P,onChange:e=>Y(e.target.value),disabled:r,children:ae.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Purpose"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:B,onChange:e=>z(e.target.value),list:"bureau-purpose-options",disabled:r}),t.jsx("datalist",{id:"bureau-purpose-options",children:re.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-2 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:b,onChange:e=>H(e.target.checked),disabled:r}),t.jsx("span",{children:"Beneficiary consent captured"})]}),t.jsx("span",{className:"text-xs text-gray-600",children:"Consent must be obtained before requesting a bureau report."})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau reference (case ID)"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:J,onChange:e=>Q(e.target.value),disabled:r,placeholder:"e.g. REF-12345"})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau requested at"}),t.jsx("input",{type:"datetime-local",className:"border px-2 py-2 rounded",value:j,onChange:e=>U(e.target.value),disabled:r}),t.jsx("span",{className:"text-xs text-gray-600",children:"Optional timestamp to track when the bureau request was sent."})]})]})]}):null,t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Tenure (months)"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:$??"",onChange:e=>D(e.target.value?Number(e.target.value):null),disabled:r||m.length===0,children:m.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Channel code"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:K,onChange:e=>O(e.target.value),list:"channel-options",disabled:r}),t.jsx("datalist",{id:"channel-options",children:f.map(e=>t.jsx("option",{value:e.code||e.name,children:e.name},`${e.code}-${e.name}`))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Disbursement destination"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:V,onChange:e=>G(e.target.value),disabled:r,children:(h.length?h:["BANK"]).map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Notes"}),t.jsx("textarea",{className:"border px-2 py-2 rounded min-h-24",value:W,onChange:e=>ie(e.target.value),disabled:r})]}),X?t.jsx("div",{className:"text-sm text-red-700",children:X}):null,t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:xe,className:"px-4 py-2 rounded bg-emerald-600 text-white shadow hover:bg-emerald-700",disabled:r,children:"Save application"}),t.jsx(ee,{to:"/loan/applications",className:"px-4 py-2 rounded border text-sm hover:bg-gray-50",children:"Cancel"})]})]})]})})}export{Be as component};
