import{f as Re,u as Te,r as l,j as e,L as q}from"./main-CxpZHTDM.js";import{c as T,T as Se,D as ke,a as Pe}from"./TenorInterestSection-DjAYEt3L.js";import{u as D,c as B,T as Ie,D as E}from"./loan-setup-store-5QIDiztH.js";import{u as W,g as Ae}from"./repayment-setup-store-bJA9caMp.js";import{i as Me,e as Le}from"./scorecard-engine-BnW47X5h.js";import{u as V}from"./scorecard-store-CRN-Wavj.js";import{u as F,g as qe}from"./workflow-store-BXSINs7Y.js";import"./trash-2-Dy6xgs9w.js";import"./middleware-CR244-OE.js";import"./v4-EwEgHOG0.js";const ae={productCode:"PL-STD",productName:"Personal Loan Standard",minAmount:5e5,maxAmount:1e7,loanTenor:{id:"default-tenor",TenorUnit:Ie.MONTH,TenorValue:[6,12,18,24]},baseInterestRate:18.5,interestRatePlans:[{interestType:"REDUCING",rateType:"FIXED",baseRate:18.5,config:{parameters:[{name:"DOWN_PAYMENT",value:30,interestRate:10},{name:"DOWN_PAYMENT",value:40,interestRate:12}]},policies:[{interestCategory:"OUTSTANDING",interestRate:1.9}]}]};function _e(){const{setupId:x}=Re.useParams(),re=Te(),U=D(s=>s.setups),o=l.useMemo(()=>x?U[x]:void 0,[x,U]),le=D(s=>s.addSetup),oe=D(s=>s.updateSetup),j=V(s=>s.scoreCards),$=V(s=>s.selectedScoreCardId),S=V(s=>s.selectScoreCard),b=F(s=>s.workflows),p=F(s=>s.selectedWorkflowId),k=F(s=>s.selectWorkflow),f=W(s=>s.plans),y=W(s=>s.selectedPlanId),P=W(s=>s.selectPlan),de=j[$],ce=l.useMemo(()=>Object.values(j)[0],[j]),i=de??ce,[c,m]=l.useState(()=>B(ae)),[I,v]=l.useState({}),[u,A]=l.useState(null),[O,M]=l.useState(()=>[T("LOW",E)]),[G,C]=l.useState([{name:"",code:""}]),[w,_]=l.useState(["BANK","WALLET"]),ie=[{type:"BANK",label:"Bank transfer",hint:"Send to any linked bank account. Details captured later in the journey."},{type:"WALLET",label:"Mobile wallet",hint:"Push to KBZpay or other supported wallets without collecting account numbers here."}],ue=l.useMemo(()=>qe(b),[b]),L=l.useMemo(()=>Ae(f),[f]),d=l.useMemo(()=>y&&f[y]?f[y]:L[0],[L,f,y]),[h,K]=l.useState(!1),[z,Y]=l.useState("MMCB"),[H,Q]=l.useState("Credit assessment"),[X,Z]=l.useState(!0),J=s=>{const t=new Map;for(const n of s){const a=n.riskGrade??"LOW",r=Pe(n.documentTypeId,{minAmount:n.minAmount,maxAmount:n.maxAmount,employmentType:n.employmentType,collateralRequired:n.collateralRequired,isMandatory:n.isMandatory}),g=t.get(a);g?g.push(r):t.set(a,[r])}return Array.from(t.entries()).map(([n,a])=>T(n,a))};l.useEffect(()=>{o?(m(B(o.product)),o.scorecardId&&S(o.scorecardId),o.workflowId&&k(o.workflowId),o.repaymentPlanId&&P(o.repaymentPlanId),C(o.channels),_(o.disbursementDestinations.map(s=>s.type)),A(o.riskResult?{...o.riskResult,inputs:{}}:null),M(o.documentRequirements.length?J(o.documentRequirements):[T("LOW",E)]),K(!!o.bureauProvider),Y(o.bureauProvider??"MMCB"),Q(o.bureauPurpose??"Credit assessment"),Z(o.bureauConsentRequired??!0)):M([T("LOW",E)])},[o,S,k,P,J]);const ee=s=>t=>{const{value:n}=t.target;m(a=>({...a,[s]:n}))},se=s=>t=>{const{value:n}=t.target,a=Number(n);m(r=>({...r,[s]:Number.isFinite(a)?a:r[s]}))},me=l.useMemo(()=>Object.values(j).sort((s,t)=>(s.name||s.scoreCardId).localeCompare(t.name||t.scoreCardId)),[j]),N=l.useMemo(()=>i?[...i.fields.map(s=>s.field)].sort((s,t)=>s.localeCompare(t)):[],[i]),te=l.useMemo(()=>{if(!i)return{};const s={};for(const t of i.fields)s[t.field]=[...t.rules??[]];return s},[i]);l.useEffect(()=>{v(s=>{const t={};for(const n of N)t[n]=s[n]??"";return t}),A(null)},[N]);const xe=s=>{const t=s.target.value;m(n=>({...n,loanTenor:{...n.loanTenor,TenorUnit:t}}))},pe=()=>{m(s=>({...s,loanTenor:{...s.loanTenor,TenorValue:[...s.loanTenor.TenorValue,0]}}))},he=s=>t=>{const n=Number(t.target.value);m(a=>{const r=[...a.loanTenor.TenorValue];return r[s]=Number.isFinite(n)?n:r[s],{...a,loanTenor:{...a.loanTenor,TenorValue:r}}})},ge=s=>{m(t=>{const n=t.loanTenor.TenorValue.filter((a,r)=>r!==s);return{...t,loanTenor:{...t.loanTenor,TenorValue:n}}})},je=s=>{m(t=>({...t,interestRatePlans:s,baseInterestRate:s[0]?.baseRate??t.baseInterestRate}))},R=c.interestRatePlans?.[0],be=()=>{m(B(ae))},fe=()=>{C(s=>[...s,{name:"",code:""}])},ne=(s,t)=>n=>{const{value:a}=n.target;C(r=>{const g=[...r],we=g[s]??{name:"",code:""};return g[s]={...we,[t]:a},g})},ye=s=>{C(t=>t.length===1?[{name:"",code:""}]:t.filter((n,a)=>a!==s))},Ne=s=>{_(t=>t.includes(s)?t.filter(n=>n!==s):[...t,s])},ve=()=>{if(!i)return;const s=Le(i,I);A(s)},Ce=()=>{const s=w.map(a=>a==="BANK"?{type:"BANK"}:{type:"WALLET"}),t=O.flatMap(a=>a.documents.map(r=>({documentTypeId:r.documentTypeId,minAmount:r.minAmount,maxAmount:r.maxAmount,employmentType:r.employmentType,collateralRequired:r.collateralRequired,riskGrade:a.grade,isMandatory:r.isMandatory}))),n={product:c,channels:G,scorecardId:i?.scoreCardId??null,scorecardName:i?.name??null,workflowId:p,workflowName:p?b[p]?.name??"(unnamed workflow)":null,riskResult:u,documentRequirements:t,disbursementType:"FULL",partialInterestRate:null,disbursementDestinations:s,repaymentPlan:d??null,bureauProvider:h?z:void 0,bureauPurpose:h?H:void 0,bureauConsentRequired:h?X:void 0,bureauCheckRequired:h};x?oe(x,n):le(n),re({to:"/loan"})};return e.jsxs("div",{className:"p-6 font-sans max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h1",{className:"text-2xl font-bold",children:[x?"Edit":"Create"," Loan Product Setup & Workflow"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(q,{to:"/loan/scorecard-setup",className:"text-sm border px-3 py-1 rounded hover:bg-gray-50",children:"Configure Scorecard"}),e.jsx(q,{to:"/workflow",className:"text-sm border px-3 py-1 rounded hover:bg-gray-50",children:"Configure workflow"})]})]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"font-semibold",children:"Loan Product"}),e.jsx("button",{onClick:be,type:"button",className:"text-sm border px-2 py-1 rounded hover:bg-gray-100",children:"Reset"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Product Code"}),e.jsx("input",{type:"text",value:c.productCode,onChange:ee("productCode"),className:"border px-2 py-1 rounded"})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Product Name"}),e.jsx("input",{type:"text",value:c.productName,onChange:ee("productName"),className:"border px-2 py-1 rounded"})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Minimum Amount"}),e.jsx("input",{type:"number",min:0,value:c.minAmount,onChange:se("minAmount"),className:"border px-2 py-1 rounded"})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Maximum Amount"}),e.jsx("input",{type:"number",min:0,value:c.maxAmount,onChange:se("maxAmount"),className:"border px-2 py-1 rounded"})]}),e.jsx(Se,{product:c,onUpdateTenureUnit:xe,onAddTenureValue:pe,onUpdateTenureValue:he,onRemoveTenureValue:ge,onInterestPlansChange:je})]}),e.jsxs("div",{className:"bg-gray-50 border rounded p-3 text-sm mt-4",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Preview"}),e.jsxs("dl",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600",children:"Code"}),e.jsx("dd",{className:"font-mono",children:c.productCode})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600",children:"Name"}),e.jsx("dd",{children:c.productName})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600",children:"Amount Range"}),e.jsxs("dd",{className:"font-mono",children:[c.minAmount.toLocaleString()," -"," ",c.maxAmount.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600",children:"Tenure"}),e.jsx("dd",{className:"font-mono",children:c.loanTenor.TenorValue.length?`${c.loanTenor.TenorValue.join(", ")} ${c.loanTenor.TenorUnit}`:"None"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-gray-600",children:"Base Rate"}),e.jsx("dd",{className:"font-mono",children:R?`${R.baseRate}% (${R.interestType} - ${R.rateType})`:"—"})]})]})]})]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-end md:justify-between mb-3",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold",children:["Scorecard Engine — ",i?.name??"(none)",i?` (Max: ${i.maxScore})`:""]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Select a saved scorecard to drive the inputs."})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Scorecard"}),e.jsx("select",{value:$,onChange:s=>S(s.target.value),className:"border px-2 py-2 rounded",children:me.map(s=>e.jsx("option",{value:s.scoreCardId,children:s.name||s.scoreCardId},s.scoreCardId))})]})]}),N.length===0?e.jsx("div",{className:"text-sm text-gray-700 border rounded p-3 bg-gray-50",children:"No fields configured in this scorecard yet. Add fields/conditions in the setup page."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:N.map(s=>{const t=Me(te[s]??[]),n=`score-${s}`;return e.jsxs("div",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("label",{htmlFor:n,children:e.jsx("span",{children:s})}),t==="boolean"?e.jsxs("select",{id:n,value:I[s]??"",onChange:a=>v(r=>({...r,[s]:a.target.value})),className:"border px-2 py-2 rounded",children:[e.jsx("option",{value:"",children:"(not set)"}),e.jsx("option",{value:"true",children:"true"}),e.jsx("option",{value:"false",children:"false"})]}):e.jsx("input",{id:n,type:t==="number"?"number":"text",value:I[s]??"",onChange:a=>v(r=>({...r,[s]:a.target.value})),className:"border px-2 py-2 rounded",placeholder:(te[s]??[]).some(a=>a.operator==="between")?"For between: e.g. 25,45":""})]},s)})}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:ve,className:"bg-blue-600 text-white px-3 py-1 rounded",type:"button",children:"Evaluate Score"}),e.jsx("button",{onClick:()=>v(s=>{const t={...s};for(const n of N)t[n]="";return t}),type:"button",className:"text-sm border px-2 py-1 rounded hover:bg-gray-100",children:"Reset Inputs"}),u&&e.jsxs("span",{className:"text-sm text-gray-700",children:["Score: ",u.totalScore," / ",u.maxScore," —"," ",u.riskGrade]})]}),u&&e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border rounded p-3 text-sm",children:[e.jsx("div",{className:"font-semibold",children:"Score Breakdown"}),e.jsxs("div",{className:"text-gray-700 mb-2",children:["Matched ",u.matchedRules," of"," ",u.breakdown.length," rules"]}),e.jsx("ul",{className:"space-y-1",children:u.breakdown.map((s,t)=>e.jsxs("li",{className:`flex justify-between gap-2 ${s.matched?"text-green-700":"text-gray-500"}`,children:[e.jsxs("span",{children:[s.fieldDescription," (",s.field,") ",s.operator," ",s.value]}),e.jsx("span",{children:s.matched?`+${s.score}`:"0"})]},"${item.field}-${idx}"))})]}),e.jsxs("div",{className:"bg-gray-50 border rounded p-3 text-sm",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Decision Engine"}),u.riskGrade==="LOW"?e.jsxs("div",{className:"p-3 rounded bg-green-100 border-green-300 text-green-800",children:[e.jsx("h3",{className:"font-bold",children:"Auto-Approved"}),e.jsx("p",{children:"The application meets all criteria for automatic approval. Proceed to the next step."})]}):u.riskGrade==="MEDIUM"?e.jsxs("div",{className:"p-3 rounded bg-yellow-100 border-yellow-300 text-yellow-800",children:[e.jsx("h3",{className:"font-bold",children:"Manual Review Required"}),e.jsx("p",{children:"The application requires manual review by an underwriter. Additional documents may be requested."})]}):e.jsxs("div",{className:"p-3 rounded bg-red-100 border-red-300 text-red-800",children:[e.jsx("h3",{className:"font-bold",children:"Auto-Rejected"}),e.jsx("p",{children:"The application does not meet the minimum criteria for a loan."})]})]})]})]}),e.jsx(ke,{riskResult:u,requirements:O,onChangeRequirements:M}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Bureau"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Configure credit bureau integration settings."})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{children:"Bureau check required"}),e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:h,onChange:s=>K(s.target.checked)})]})]}),h&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4",children:[e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Bureau provider"}),e.jsx("input",{type:"text",name:"bureauProvider",value:z,onChange:s=>Y(s.target.value),className:"border px-2 py-1 rounded",placeholder:"e.g., MMCB"})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{children:"Bureau purpose"}),e.jsx("input",{type:"text",name:"bureauPurpose",value:H,onChange:s=>Q(s.target.value),className:"border px-2 py-1 rounded",placeholder:"e.g., Credit assessment"})]}),e.jsxs("label",{className:"flex flex-col gap-2 text-sm",children:[e.jsx("span",{children:"Bureau consent required"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:X,onChange:s=>Z(s.target.checked)}),e.jsx("span",{className:"text-xs text-gray-700",children:"Indicates whether beneficiary consent must be captured before bureau pulls."})]})]})]})]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Workflow"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Choose a saved workflow to visualize/apply."})]}),e.jsxs("select",{className:"border px-2 py-2 rounded",value:p??"",onChange:s=>k(s.target.value||null),children:[e.jsx("option",{value:"",children:"(none selected)"}),ue.map(s=>e.jsx("option",{value:s.workflowId,children:s.name},s.workflowId))]})]}),p&&b[p]?e.jsxs("div",{className:"mt-3 text-xs text-gray-700",children:[e.jsx("span",{className:"font-semibold",children:"Selected:"})," ",b[p].name]}):null]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Repayment"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Choose a repayment plan configured in Repayment Setup."})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("select",{className:"border px-2 py-2 rounded min-w-50",value:y??d?.planId??"",onChange:s=>P(s.target.value||null),children:L.map(s=>e.jsx("option",{value:s.planId,children:s.name},s.planId))}),e.jsx(q,{to:"/loan/repayment-setup",className:"text-sm border px-3 py-2 rounded hover:bg-gray-100",children:"Manage plans"})]})]}),d?e.jsxs("div",{className:"bg-gray-50 border rounded p-3 text-sm",children:[e.jsx("div",{className:"font-semibold mb-1",children:d.name}),e.jsxs("div",{className:"text-xs text-gray-700 mb-2",children:[d.method," · ",d.frequency]}),e.jsxs("dl",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-xs text-gray-700",children:[e.jsxs("div",{children:[e.jsx("dt",{children:"Due day"}),e.jsx("dd",{children:d.dueDayOfMonth??"—"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Grace period"}),e.jsxs("dd",{children:[d.gracePeriodDays," days"]})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Late fee"}),e.jsxs("dd",{children:[d.lateFeeFlat.toLocaleString()," +"," ",d.lateFeePct,"%"]})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Prepayment"}),e.jsxs("dd",{children:[d.prepaymentPenaltyPct,"%"]})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Autopay"}),e.jsx("dd",{children:d.autopayRequired?"Required":"Optional"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Rounding step"}),e.jsx("dd",{children:d.roundingStep})]})]}),d.description?e.jsx("p",{className:"text-xs text-gray-700 mt-2",children:d.description}):null]}):e.jsx("div",{className:"text-sm text-gray-700",children:"No repayment plans yet. Create one in Repayment Setup."})]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Channel Configuration"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Add delivery channels with a display name and code."})]}),e.jsx("button",{type:"button",onClick:fe,className:"text-sm border px-3 py-1 rounded hover:bg-gray-100",children:"Add channel"})]}),e.jsx("div",{className:"space-y-3",children:G.map((s,t)=>{const n=`channel-name-${t}`,a=`channel-code-${t}`;return e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-[1fr_1fr_auto] md:items-end",children:[e.jsxs("label",{className:"flex flex-col gap-1 text-sm",htmlFor:n,children:[e.jsx("span",{children:"Channel name"}),e.jsx("input",{id:n,type:"text",value:s.name,onChange:ne(t,"name"),className:"border px-2 py-2 rounded",placeholder:"e.g. WhatsApp"})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",htmlFor:a,children:[e.jsx("span",{children:"Channel code"}),e.jsx("input",{id:a,type:"text",value:s.code,onChange:ne(t,"code"),className:"border px-2 py-2 rounded",placeholder:"e.g. WA-01"})]}),e.jsx("button",{type:"button",onClick:()=>ye(t),className:"text-sm border px-3 py-2 rounded hover:bg-gray-100",children:"Remove"})]},`${s.code||"code"}-${t}`)})})]}),e.jsxs("section",{className:"border p-4 rounded mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:"Disbursement"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Pick every destination you want to enable. We will collect account and wallet details later in the flow."})]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Multi-select — no bank setup here."})]}),e.jsx("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:ie.map(s=>{const t=w.includes(s.type);return e.jsxs("label",{className:`flex gap-3 border rounded p-3 text-sm transition hover:border-blue-300 ${t?"border-blue-500 bg-blue-50":"border-gray-200"}`,children:[e.jsx("input",{type:"checkbox",className:"mt-1 accent-blue-600",checked:t,onChange:()=>Ne(s.type)}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"font-semibold",children:s.label}),e.jsx("span",{className:"text-xs text-gray-700",children:s.hint})]})]},s.type)})}),w.length===0?e.jsx("p",{className:"text-xs text-red-700 mt-3",children:"Choose at least one payout rail to proceed."}):e.jsxs("div",{className:"mt-3 text-xs text-gray-700",children:["Enabled: ",w.join(", ")]})]}),e.jsx("section",{className:"mt-8",children:e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("button",{onClick:Ce,type:"button",className:"w-full py-4 text-lg font-semibold bg-emerald-600 text-white rounded-lg shadow hover:bg-emerald-700",children:[x?"Update":"Save"," Product Setup"]})})})]})}export{_e as component};
