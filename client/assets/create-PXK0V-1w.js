import{b as he,r as s,j as t,L as ee}from"./main-BWVog3ZY.js";import{u as ge}from"./loan-application-store-BVJUN4Jp.js";import{u as fe,g as be}from"./loan-setup-store-CxktrUWb.js";import{i as je,e as ve}from"./scorecard-engine-QAjBW2Bv.js";import{u as Ne}from"./scorecard-store-DTl_5BzP.js";import"./middleware-DbOJw5Dy.js";import"./v4-EwEgHOG0.js";function Pe(){const te=he(),M=fe(e=>e.setups),E=Ne(e=>e.scoreCards),se=ge(e=>e.addApplication),u=s.useMemo(()=>be(M),[M]),[p,R]=s.useState(u[0]?.id??""),a=s.useMemo(()=>u.find(e=>e.id===p)??u[0]??null,[u,p]);s.useEffect(()=>{u.length!==0&&(a||R(u[0].id))},[a,u]);const m=a?.product.tenureMonths??[],f=a?.channels??[],h=(a?.disbursementDestinations??[]).map(e=>e.type),v="Myanmar Credit Bureau",N="Credit assessment",r=s.useMemo(()=>a?.scorecardId?E[a.scorecardId]??null:null,[a?.scorecardId,E]),ae=s.useMemo(()=>{const e=new Set;return e.add(v),r?.bureauProvider?.trim()&&e.add(r.bureauProvider.trim()),Array.from(e)},[r?.bureauProvider]),re=s.useMemo(()=>{const e=new Set;return e.add(N),e.add("Pre-approval"),e.add("Account review"),e.add("Regulatory reporting"),r?.bureauPurpose?.trim()&&e.add(r.bureauPurpose.trim()),Array.from(e)},[r?.bureauPurpose]),y=s.useMemo(()=>r?[...r.fields.map(e=>e.field)].sort((e,l)=>e.localeCompare(l)):[],[r]),q=s.useMemo(()=>{if(!r)return{};const e={};for(const l of r.fields)e[l.field]=[...l.rules??[]];return e},[r]),S=s.useMemo(()=>y.filter(e=>e!=="age"&&e!=="monthlyIncome"),[y]),[C,ne]=s.useState(""),[A,le]=s.useState(""),[F,oe]=s.useState(""),[w,ce]=s.useState(""),[I,de]=s.useState(""),[T,ue]=s.useState(""),[$,D]=s.useState(m[0]??null),[K,O]=s.useState(f[0]?.code??""),[V,G]=s.useState(h[0]??"BANK"),[B,Y]=s.useState(v),[P,z]=s.useState(N),[b,H]=s.useState(!1),[J,Q]=s.useState(""),[j,U]=s.useState(""),[W,ie]=s.useState(""),[X,c]=s.useState(null),[Z,k]=s.useState({}),[d,_]=s.useState(null);s.useEffect(()=>{D(m[0]??null)},[p,m]),s.useEffect(()=>{O(f[0]?.code??"")},[p,f]),s.useEffect(()=>{G(h[0]??"BANK")},[p,h]),s.useEffect(()=>{k(e=>{const l={};for(const o of S)l[o]=e[o]??"";return l}),_(null)},[a?.id,S]),s.useEffect(()=>{const e=r?.bureauProvider?.trim()||v,l=r?.bureauPurpose?.trim()||N;Y(e),z(l),H(!1),Q(""),U("")},[r?.scoreCardId]);const n=u.length===0,pe="DRAFT",me=()=>{if(!r){c("This loan setup is missing a linked scorecard.");return}const e={};for(const o of y){if(o==="age"){e[o]=w;continue}if(o==="monthlyIncome"){e[o]=I;continue}e[o]=Z[o]??""}const l=ve(r,e);_(l),c(null)},xe=()=>{if(n||!a)return;if(!C.trim()){c("Beneficiary name is required.");return}if(!A.trim()){c("National ID is required.");return}const e=Number(w);if(!Number.isFinite(e)||e<=0){c("Enter a valid age.");return}const l=Number(I);if(!Number.isFinite(l)||l<0){c("Enter a valid monthly income.");return}const o=Number(T);if(!Number.isFinite(o)){c("Enter a valid amount.");return}if(a.product.minAmount&&o<a.product.minAmount){c(`Amount must be at least ${a.product.minAmount.toLocaleString()}.`);return}if(a.product.maxAmount&&o>a.product.maxAmount){c(`Amount must be at most ${a.product.maxAmount.toLocaleString()}.`);return}if(!B.trim()){c("Select a credit bureau provider.");return}if(!P.trim()){c("Enter the purpose for the bureau check.");return}if(!b){c("Beneficiary consent is required before checking the bureau.");return}const x=j?Date.parse(j):null;if(j&&Number.isNaN(x)){c("Enter a valid requested-at date/time.");return}c(null);const i=d?.totalScore??a.totalScore??null,g=d?.maxScore??r?.maxScore??null;se({beneficiaryName:C,nationalId:A,phone:F,age:e,monthlyIncome:l,requestedAmount:o,tenureMonths:$,channelCode:K,destinationType:V,bureauProvider:B,bureauPurpose:P,bureauConsent:b,bureauReference:J,bureauRequestedAt:x,notes:W,setupId:a.id,productCode:a.product.productCode,productName:a.product.productName,creditScore:i,creditMax:g,workflowId:a.workflowId,workflowName:a.workflowName}),te({to:"/loan/applications"})};return t.jsx("div",{className:"p-6 font-sans max-w-5xl mx-auto",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Loan applications"}),t.jsx("h1",{className:"text-2xl font-semibold",children:"Create application"})]}),n?t.jsxs("div",{className:"border rounded p-4 bg-yellow-50 text-sm text-gray-800",children:["You need at least one saved loan setup before creating applications.",t.jsx("div",{className:"mt-2",children:t.jsx(ee,{to:"/loan/setup",className:"text-blue-600 hover:underline",children:"Go to Loan Setup"})})]}):t.jsxs("div",{className:"space-y-4 border rounded p-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Loan setup (product)"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:p,onChange:e=>R(e.target.value),children:u.map(e=>t.jsxs("option",{value:e.id,children:[e.product.productName," (",e.product.productCode,")"]},e.id))}),t.jsxs("span",{className:"text-xs text-gray-600",children:["Tenure options: ",m.join(", ")||"—"," months · Range: ",a?.product.minAmount.toLocaleString()," -"," ",a?.product.maxAmount.toLocaleString()]})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Status"}),t.jsx("input",{readOnly:!0,value:pe,className:"border px-2 py-2 rounded bg-gray-50"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Beneficiary name"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:C,onChange:e=>ne(e.target.value),disabled:n})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"National ID"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:A,onChange:e=>le(e.target.value),disabled:n})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Phone"}),t.jsx("input",{type:"tel",className:"border px-2 py-2 rounded",value:F,onChange:e=>oe(e.target.value),disabled:n})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Age"}),t.jsx("input",{type:"number",min:0,className:"border px-2 py-2 rounded",value:w,onChange:e=>ce(e.target.value),disabled:n})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Monthly income"}),t.jsx("input",{type:"number",min:0,className:"border px-2 py-2 rounded",value:I,onChange:e=>de(e.target.value),disabled:n})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Requested amount"}),t.jsx("input",{type:"number",min:a?.product.minAmount??0,max:a?.product.maxAmount??void 0,className:"border px-2 py-2 rounded",value:T,onChange:e=>ue(e.target.value),disabled:n}),t.jsx("span",{className:"text-xs text-gray-600",children:a?`Allowed: ${a.product.minAmount.toLocaleString()} - ${a.product.maxAmount.toLocaleString()}`:"Save a loan setup first."})]})]}),t.jsxs("div",{className:"space-y-3 border rounded p-4",children:[t.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Credit score"}),t.jsx("div",{className:"text-base font-semibold",children:r?`${r.name} (Max ${r.maxScore})`:"No scorecard attached"})]}),d?t.jsxs("div",{className:"text-sm text-gray-700",children:["Score ",d.totalScore," / ",d.maxScore," —",d.riskGrade]}):null]}),r?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:S.map(e=>{const l=je(q[e]??[]),o=Z[e]??"",x=`score-${e}`;return t.jsxs("label",{className:"flex flex-col gap-1 text-sm",htmlFor:x,children:[t.jsx("span",{children:e}),l==="boolean"?t.jsxs("select",{id:x,value:o,onChange:i=>{const g=i.target.value;k(L=>({...L,[e]:g}))},className:"border px-2 py-2 rounded",disabled:n,children:[t.jsx("option",{value:"",children:"(not set)"}),t.jsx("option",{value:"true",children:"true"}),t.jsx("option",{value:"false",children:"false"})]}):t.jsx("input",{id:x,type:l==="number"?"number":"text",value:o,onChange:i=>{const g=i.target.value;k(L=>({...L,[e]:g}))},className:"border px-2 py-2 rounded",placeholder:(q[e]??[]).some(i=>i.operator==="between")?"For between: e.g. 25,45":"",disabled:n})]},e)})}),t.jsxs("div",{className:"flex gap-2 items-center",children:[t.jsx("button",{type:"button",onClick:me,className:"px-4 py-2 rounded bg-blue-600 text-white shadow hover:bg-blue-700",disabled:n,children:"Calculate credit score"}),d?t.jsxs("span",{className:"text-sm text-gray-700",children:["Result: ",d.totalScore," /"," ",d.maxScore," — ",d.riskGrade]}):null]})]}):t.jsx("p",{className:"text-sm text-gray-700",children:"Link a scorecard in Loan Setup to calculate credit scores per beneficiary."})]}),t.jsxs("div",{className:"space-y-3 border rounded p-4",children:[t.jsxs("div",{className:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-600",children:"Credit bureau check"}),t.jsx("div",{className:"text-base font-semibold",children:"Capture consent and request details"})]}),b?t.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100",children:"Consent ready"}):t.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-yellow-50 text-yellow-800 border border-yellow-200",children:"Consent required"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau provider"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:B,onChange:e=>Y(e.target.value),disabled:n,children:ae.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Purpose"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:P,onChange:e=>z(e.target.value),list:"bureau-purpose-options",disabled:n}),t.jsx("datalist",{id:"bureau-purpose-options",children:re.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-2 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:b,onChange:e=>H(e.target.checked),disabled:n}),t.jsx("span",{children:"Beneficiary consent captured"})]}),t.jsx("span",{className:"text-xs text-gray-600",children:"Consent must be obtained before requesting a bureau report."})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau reference (case ID)"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:J,onChange:e=>Q(e.target.value),disabled:n,placeholder:"e.g. REF-12345"})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Bureau requested at"}),t.jsx("input",{type:"datetime-local",className:"border px-2 py-2 rounded",value:j,onChange:e=>U(e.target.value),disabled:n}),t.jsx("span",{className:"text-xs text-gray-600",children:"Optional timestamp to track when the bureau request was sent."})]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Tenure (months)"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:$??"",onChange:e=>D(e.target.value?Number(e.target.value):null),disabled:n||m.length===0,children:m.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Channel code"}),t.jsx("input",{type:"text",className:"border px-2 py-2 rounded",value:K,onChange:e=>O(e.target.value),list:"channel-options",disabled:n}),t.jsx("datalist",{id:"channel-options",children:f.map(e=>t.jsx("option",{value:e.code||e.name,children:e.name},`${e.code}-${e.name}`))})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Disbursement destination"}),t.jsx("select",{className:"border px-2 py-2 rounded",value:V,onChange:e=>G(e.target.value),disabled:n,children:(h.length?h:["BANK"]).map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),t.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[t.jsx("span",{children:"Notes"}),t.jsx("textarea",{className:"border px-2 py-2 rounded min-h-24",value:W,onChange:e=>ie(e.target.value),disabled:n})]}),X?t.jsx("div",{className:"text-sm text-red-700",children:X}):null,t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{type:"button",onClick:xe,className:"px-4 py-2 rounded bg-emerald-600 text-white shadow hover:bg-emerald-700",disabled:n,children:"Save application"}),t.jsx(ee,{to:"/loan/applications",className:"px-4 py-2 rounded border text-sm hover:bg-gray-50",children:"Cancel"})]})]})]})})}export{Pe as component};
