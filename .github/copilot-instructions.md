# Copilot Instructions

- **Stack**: TanStack Start + Vite + React 19 + TypeScript; file-based routing via TanStack Router with generated route tree; Tailwind CSS (v4 plugin) for styling; Zustand for client state; React Flow (@xyflow) for workflow canvas.
- **Working rules**: Do not change formatting manually (no auto-formatting in responses); do not reorder/sort imports or remove unused code—leave that to Biome; do not run Biome commands—user handles formatting/linting.
- **Run/Build/Test**: `npm run dev` (Vite, port 3000), `npm run build`/`preview`, `npm run test` (vitest run), lint/format/check with Biome (`npm run lint|format|check`).
- **Env**: Anthropic key expected (`ANTHROPIC_API_KEY`) per README.
- **Routing shell**: [src/routes/__root.tsx](src/routes/__root.tsx) sets document head, global CSS, header, and mounts TanStack Devtools plugins (router, query, store, AI). Do not edit `routeTree.gen.ts`; add routes in [src/routes](src/routes).
- **Router wiring**: [src/router.tsx](src/router.tsx) builds the router with TanStack Query context from [src/integrations/tanstack-query/root-provider.tsx](src/integrations/tanstack-query/root-provider.tsx) and enables SSR/query integration via `setupRouterSsrQueryIntegration`.
- **Path aliases**: `@/*` -> `src/*` configured in [tsconfig.json](tsconfig.json).
- **Devtools**: Root shell registers TanStack Router devtools, TanStack Query devtools, custom store devtools, and AI devtools plugins ([src/lib/ai-devtools.tsx](src/lib/ai-devtools.tsx), [src/lib/demo-store-devtools.tsx](src/lib/demo-store-devtools.tsx)).
- **Styling**: Tailwind classes alongside global CSS in [src/styles.css](src/styles.css); components largely use utility classes instead of CSS modules.
- **Workflow builder**: [src/components/workflow/WorkflowCanvas.tsx](src/components/workflow/WorkflowCanvas.tsx) wraps React Flow with custom nodes/edges; seeds start/end + a default node; prevents connecting into start or out of end; start/end nodes are non-removable. Buttons add generic or condition nodes; edges default to animated `custom-edge`; toggle to view raw JSON.
- **Custom nodes**: Start/End nodes only expose source/target handles ([src/components/workflow/StartNode.tsx](src/components/workflow/StartNode.tsx), [src/components/workflow/EndNode.tsx](src/components/workflow/EndNode.tsx)). `CustomNode` allows renaming/removing nodes and pruning incoming/outgoing edges; `ConditionNode` holds an `input` string and exposes edge removal controls; `CustomEdge` deletes itself on click; `DataEdge` renders an editable label persisted in edge `data.input`.
- **Workflow persistence**: Zustand store in [src/lib/workflow-store.ts](src/lib/workflow-store.ts) persists to `loan-workflows`; `addWorkflow` requires a trimmed, non-empty name, auto-selects the created workflow, and records optional `sourceInstanceId`; `getWorkflowList` sorts by name then creation time.
- **Loan setup flow**: [src/routes/loan/setup.tsx](src/routes/loan/setup.tsx) is the main orchestration page—configures loan product, channels, scorecard selection, workflow selection, repayment plan, and disbursement settings; invokes `evaluateScoreCard` for risk output and persists a snapshot via `useLoanSetupStore.addSetup`, then links to workflow/scorecard setup pages.
- **Scorecards**: Store in [src/lib/scorecard-store.ts](src/lib/scorecard-store.ts) persists to `loan-scorecard`; seeded `defaultScoreCard`; operators are fixed (`==`, `!=`, `>`, `<`, `>=`, `<=`, `between`, `in`, `notin`, `contains`). `removeScoreCard` guards against empty state by restoring the default.
- **Score engine**: [src/lib/scorecard-engine.ts](src/lib/scorecard-engine.ts) infers field kinds from operators, parses inputs (numbers/booleans), treats missing inputs as skipped (no match), caps total score at `maxScore`, maps score to `riskGrade` (LOW/MEDIUM/HIGH) and minimal docs list, and returns a detailed per-rule breakdown.
- **Repayment plans**: Store in [src/lib/repayment-setup-store.ts](src/lib/repayment-setup-store.ts) persists to `loan-repayment-plans`; seeded "Standard EMI" plan; `addPlan` trims names, clamps due day to 1–28, coerces/guards numeric fields, and auto-selects the created plan; `removePlan` restores the seed if the last plan is removed.
- **Loan Application store**: Zustand store in `src/lib/loan-application-store.ts` persists to `loan-applications`; `addApplication` creates a new loan application with a unique `applicationNo`, `updateStatus` changes the application status, `advanceWorkflowStage` updates the workflow progress, and `resetWorkflowProgress` resets it.
- **Loan Application creation**: The route `src/routes/loan/applications/create.tsx` handles new loan application creation. It uses `useLoanApplicationStore` to add new applications and `useLoanSetupStore` to get available loan setups. It also integrates with the `scorecard-engine` to evaluate risk based on the selected scorecard.
- **Scorecards**: Store in `src/lib/scorecard-store.ts` persists to `loan-scorecard`; seeded `defaultScoreCard`; operators are fixed (`==`, `!=`, `>`, `<`, `>=`, `<=`, `between`, `in`, `notin`, `contains`). `removeScoreCard` guards against empty state by restoring the default. The store normalizes scorecard structure, including a fallback for a legacy flat rule structure. A demo scorecard can be found in `src/lib/score-card.ts`.
- **Workflow demo route**: [src/routes/workflow.tsx](src/routes/workflow.tsx) renders `WorkflowCanvas` (currently passes empty JSON; sample workflow data kept inline for reference).
- **Demo content**: README notes files prefixed with `demo` are safe to delete; many example components under `src/components/demo...` and `src/routes/demo` exist purely as samples.
- **Shadcn usage**: Per [.cursorrules](.cursorrules), install new Shadcn components with `pnpm dlx shadcn@latest add <component>` (e.g., button).

If anything here is unclear or missing, tell me what to expand or refine.
